---
title: "Exploring Audubon SC Motus"
author: "Dave Eslinger"
date: "5/6/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE,
                      message = FALSE,
                      error = FALSE)
```

```{r open_libraries}
suppressPackageStartupMessages({
  library(motus)
  library(motusData)
  library(tidyverse)
  library(here)
  library(DBI)
  library(RSQLite)
  library(lubridate)
})
```

```{r set_environment}
Sys.setenv(TZ = "UTC")
```

Getting sample data, use "motus.sample" for user and password for this sample data.  If you screw it up, use `motusLogout()`.

```{r get_one_receiver_data}
proj.num <- "SG-329ERPI3DD60"
sc_rcvr.motus <- tagme(projRecv = proj.num, 
                       new = FALSE,
                       update = TRUE,
                       dir = here("data"))


```

```{r check_SQL_tables}
# specify the filepath where your .motus file is saved, and the file name.
sql.file <- dbConnect(SQLite(), 
                      here("data","SG-329ERPI3DD60.motus"))

# get a list of tables in the .motus file specified above.
dbListTables(sql.file) 

dbListFields(sql.file, "hits")

tbl.alltags <- tbl(sql.file, "alltags")

str(tbl.alltags)

tbl.alltags %>% 
  collect() %>%
  names() # list the variable names in the table

```

No GPS for this receiver, so don't try to get any.


Convert to data frame to make things more _normal_.

Timestamp (`ts`) is seconds since Jan. 1970.  Convert to datetime with {lubridate}.

```{r convert_to_df_and_fix_time}

df.alltags <- tbl.alltags %>% 
  select(-c(tsCorrected, deviceID:antHeight)) %>% 
  collect() %>% 
  as.data.frame() %>%     # for all fields in the df (data frame)
  mutate(ts = as_datetime(ts, tz = "UTC", origin = "1970-01-01"))

names(df.alltags)     # field names
str(df.alltags)       # structure of your data fields
head(df.alltags)      # prints the first 6 rows of your df to the console
summary(df.alltags)   # summary of each column in your df
```

Can load subsets of full table using {dplyr}.

Can select just some variables:

```{r load_select_variables}
# to grab a subset of variables, in this case a unique list of Motus tag IDs at
# each receiver and antenna.
df.alltagsSub <- tbl.alltags %>%
  select(recv, port, motusTagID) %>%
  distinct() %>% 
  collect() %>% 
  as.data.frame() 

names(df.alltagsSub)     # field names
str(df.alltagsSub)       # structure of your data fields
head(df.alltagsSub)      # prints the first 6 rows of your df to the console
summary(df.alltagsSub)   # summary of each column in your df

```

